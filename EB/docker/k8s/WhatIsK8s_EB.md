# What is k8s

> 목차
> * 배경 용어 정리
> * 어플리케이션 배포 환경의 변화
> * 쿠버네티스 구성 방법
> * 쿠버네티스 구성 요소

## 1. 배경 용어 정리

|용어|뜻|
|---|---|
|컨테이너|앱이 구동되는 환경까지 감싸서 실행할 수 있도록 하는 격리 기술|
|컨테이너 런타임|컨테이너를 다루는 도구|
|도커|컨테이너를 다루는 도구 중 가장 유명한 것|
|쿠버네티스|컨테이너 런타임을 통해 컨테이너를 오케스트레이션 하는 도구|
|오케스트레이션|여러 서버에 걸친 컨테이너 및 사용하는 환경 설정을 관리하는 행위|

* 컨테이너

우리가 구동하려는 어플리케이션을 실행할 수 있는 환경까지 감싸서 어디서든 쉽게 실행할 수 있도록 해주는 기술이다.

> 내가 도커로 몽고디비랑 spring application을 한 번에 도커에 올려서 실행하려고 했던 것처럼

예를 들어, PC에 오라클을 설치할 때를 생각해보자. 특정 경로에 맞춰 설치를 해야 하거나, 내 컴퓨터에 필요한 옵션을 일일이 맞춰주느라 설치 과정에서 힘들었더 경험이 있을 거다. 컨테이너는 이러한 환경까지 모두 포함하여 독립적으로 프로그램을 실행할 수 있도록 도와주는 기술이다. 컨테이너 환경을 묶어서 배포한 컨테이너 이미지라는 프로그램을 내려 받아 구동하면 실행되기 때문에, 각종 설정 과정이 줄어 들어서 좀 더 편하게 사용할 수 있다.

* 컨테이너 런타임

컨테이너를 사용할 때 필요한 도구가 컨테이너 런타임이다. 컨테이너를 쉽게 내려받거나 공유하고 구동할 수 있도록 해주는 도구로, 종류가 다양하다. 그중 가장 유명한 것이 도커이다. 

* 쿠버네티스 및 오케스트레이션

**컨테이너 런타임을 통해 컨테이너를 다루는 도구**를 말한다. 쿠버네티스가 해주는 일은 여러 서버에 컨테이너를 분산해서 배치하거나, 문제가 생긴 컨테이너를 교체하거나, 컨테이너가 사용할 비밀번호나 환경 설정을 관리하고 주입해주는 일 등이다. 이것을 컨테이너 오케스트레이션이라고 한다. 

**쿠버네티스는 컨테이너를 다루는 도구이기 때문에, 도커를 다루는 도구는 아니다.*

## 2. 어플리케이션 배포 환경의 변화

<여기 그림 넣어야 한다.>

### 전통적 방식의 배포

가상화 이전에 쓰이던 방식으로, 물리적인 컴퓨터 한 대에 하나의 OS를 깔고 여러 가지 프로그램을 설치하는 방식이다. 가장 오래되고 단순한 방식이며, 단일 목적 시스템일 경우에 큰 문제 없이 동작한다.

단, 이 방식에는 문제점이 있다. 인터넷 뱅킹을 위해 보안 프로그램을 많이 설치했더니 게임이나 웹 브라우저 성능이 떨어지는 걸 경험해봤을 거다. 한 대의 컴퓨터에서 모든 것을 처리하려고 하면 어떤 프로그램 동작이 다른 프로그램의 동작을 간섭하거나, 특정 프로그램이 성능을 독점할 경우 또 다른 프로그램의 성능이 떨어지는 단점이 있다. 성능이 떨어지는 정도에 그치지 않고 프로그램의 중단까지도 유발할 수 있다. 이 문제를 어떻게 해결할까 ?

### 가상머신 기반 배포

위의 문제를 해결하기 위해 등장한 것이 가상 머신 기반의 배포이다. OS 위에 위치한 하이퍼바이저는 하나의 시스템 상에서 가상 컴퓨터를 여러 개 구동할 수 있도록 해주는 중간 계층을 의미한다. 그리고 가장 윗단인 APP은 실행하고자 하는 프로그램, 그 아래 Bin/ Library는 프로그램이 실행하는 데 필요한 환경과 관련된 파일이라고 보면 된다. 

가상머신은 말 그대로 가상 컴퓨터이다. 컴퓨터이기 때문에 CPU, 메모리, 저장 장치 등을 개별적으로 할당할 수 있다. 앞선 문제를 다시 떠올려보자. 게임 프로그램과 인터넷 뱅킹 보안 프로그램이 간섭을 일으켜 문제가 된다면 두 프로그램을 각각의 가상머신에서 실행시키면 된다. 하나의 컴퓨터 안에서 2개의 가상화된 컴퓨터가 동작하기 때문에 서로 간섭을 일으키지 않게 된다. CPU나 메모리를 많이 차지하는 게임에 더 할당하고 인터넷 뱅킹용 가상 머신에는 적게 할ㄷ하는 등 다중화와 분산 처리가 가능하다.

단, 이 방식에서 가상머신은 완전한 컴퓨터이고 가상머신에 일일이 운영체제를 설치해야 하기 때문에 컨테이너 중심의 배포보다는 무거운 편이다.

### 컨테이너 중심의 배포

앞선 가상머신 기반 배포에서 하이퍼바이저 위치에 컨테이너 런타임으로 대체되었다. 컨테이너는 가상머신과 달리 프로그램 구동을 위해서 OS를 매번 설치할 필요가 없다. 하나의 OS 만을 사용한다. 

컨테이너 기반 배포에서 컨테이너는 OS 하단이 어떻게 동작하는 지 직접 관심을 두지 않는다. 그래서 가상머신 위에 올라간 OS에서 컨테이너 기반 배포를 하는 것이 가능하다.

앞선 게임과 인터넷 뱅킹 예시를 다시 떠올려보자. 게임과 인터넷 뱅킹이 각각 실행되면서 '이 컴퓨터에서 나만 구동되고 있다.'라고 판단할 수 있도록, 실제로 두 프로그램 간에 간섭을 일으킬 수 없는 장벽을 친다. 이러한 장벽을 치는 것과 동시에 OS는 게임과 인터넷 뱅킹이 사용할 수 있는 CPU, 메모리 등의 자원 또한 독립적으로 사용할 수 있도록 할당하고 관리한다. 이러한 과정을 통해 게임과 인터넷 프로그램은 스스로를 '서로 다른 컴퓨터에서 깔려 있다.'고 생각하게 된다. 이와 같은 컨테이너 동작 방식을 OS 커널을 공유하는 가상화라고 표현한다. 

* OS 커널

[파일](./WhatIsKernel_EB.md) 참고

컨테이너는 OS를 공유하는 방식이기 때문에, 어떤 프로그램의 문제가 다른 프로그램을 간섭할 수는 없다. 그러나 내 프로그램의 문제가 OS에 문제를 일으킬 경우에는 OS에서 구동중인 전체 컨테이너의 문제가 될 수 있다.

## 3. 쿠버네티스 구성 방법

개발 용도에 적합한 쿠버네티스 구성 방법은 미니쿠브이다. 미니쿠브는 쿠버네티스 개발자들 중 특정한 주제에 관심을 가진 사람들이 모인 SIG 에서 만든 도구이다. 

* 로컬 시스템에 쉽게 설치 가능하다.

리눅스, 맥, 윈도우를 지원하며, 설치 파일 이외에도 각 OS가 지원하는 패키지 매니저를 활용하여 편리하게 설치할 수 있다. 이렇게 설치가 간단하면서도 쿠버네티스가 제공하는 대부분의 기능을 활용할 수 있다는 장점이 있다. 

* 개발 도구와의 연계성

인텔리제이와 같은 개발 도구와 연계할 수 있어서 내 컴퓨터에서 개발한 프로젝트가 쿠버네티스상에서 동작하는 결과를 바로 확인할 수 있다. 

* 단일 노드 형태로 동작

로컬에 설치되며 단일 노드 형태로 동작하기 때문에 다중 노드를 구성하여 수행해야 하는 작업을 하기에는 곤란하다. ㄴ

* 가상화 도구가 추가로 필요

노드를 가상화된 형태로 생성하기 때문에 도커 등의 가상화 도구가 필요하다.

<hr/>

학습 및 개발 환경을 넘어 보다 실질적으로 활용 가능한 쿠버네티스 클러스터를 구성하고 싶은데 리소스가 충분하지 않다면 k3s를 사용할 것을 추천한다. k3s는 랜처래스에서 개발한 경량의 쿠버네티스 배포판이다.

* 단일 파일로 구성

k3s 실행 파일은 단일 파일로 구성되어 있으며, 서버와 에이전트만 구동하면 쿠버네티스의 각 구성 요소가 간편하게 설치되면서 쿠버네티스 클러스터를 쉽게 구성할 수 있다.

* 초소형 컴퓨터에서 사용 가능

내장 구성 요소 중 쿠버네티스의 각종 환경 정보를 경량의 내장 데이터베이스인 SQLite로 사용하기에 매우 가볍게 동작한다. 그래서 사물인터넷 용도 혹은 라즈베리파이 같은 학습용 초소형 컴퓨터에도 사용할 수 있다.

* 높은 성능과 안정성에서는 부적합

대부분의 구성 요소가 매우 단순화되어 있어 높은 성능과 안정성을 요구하는 시스템에는 부적합할 수 있다.

<hr/>

조금 더 대규모 환경에 적합한 쿠버네티스 구성 방법으로는 랜처가 있다. 

* 모니터링, 보안 관련 기능 설치 easy

쿠버네티스 클러스터뿐 아니라 운영에 필요한 모니터링, 보안 관련 기능을 쉽게 설치할 수 있다.

* 추가적인 도구 설치 easy

추가적인 기능이 필요할 때, 사용자가 설정 방법을 고민할 필요 없이 랜처가 제공하는 마켓 플레이스에서 도구를 설치하고 구성할 수 있다.

* 쿠버네티스 클러스터 생성 및 관리 easy

랜처의 관리 도구를 사용해서 새로운 쿠버네티스 클러스터를 쉽게 생성하고 여러 클러스터를 한곳에서 관리할 수 있다. 이때 클라우드에 대한 전문지식이 부족해도 여러 클라우드를 동시에 활용하는 멀티 클라우드 환경을 구성할 수 있다.

다만 랜처는 대규모 시스템 관리까지 염두에 둔 플랫폼이기에 자체적인 구성 요소가 많이 포함되어 있어 다른 도구에 비해 조금 더 무거운 느낌이다. 

<hr/>

퍼블릭 클라우드에서 제공하는 매니지드 쿠버네티스 서비스를 사용하면 가장 쉽고 빠르게 쿠버네티스를 접할 수 있다. 

[더 많은 게 알고 싶다면 깃헙을 보자](https://github.com/kelseyhightower/kubernetes-the-hard-way)

## 4. 쿠버네티스 구성 요소

**컨트롤 플레인 컴포넌트**와 **노드 컴포넌트**로 나눌 수 있다.

### 컨트롤 플레인 컴포넌트

> 쿠버네티스 기능 제어를 전체적으로 담당한다.

* kube-apiserver

공식문서에서는 '쿠버네티스 컨트롤 플레인의 프론트 엔드'라고 표현한다. 쉽게 생각하면, 프론트 데스크처럼 이 방문자가 적절한 방문자인지 시스템에서 검색하거나 관련된 직원에게 문의하여 방문증을 발급하고, 가야할 곳을 안내해주는 역할이다. 

즉, 쿠버네티스 클러스터로 들어오는 요청ㅇ르 가장 앞에서 접수하는 역할을 한다. 

> 스프링 내부에서는 누가 제일 먼저 받지 ? security를 사용하지 않는다면 디스패처 서블릿이 프론트 컨트롤러로서 제일 먼저 요청을 받는다.

* etcd

쿠버네티스 클러스터가 동작하기 위해서는 클러스터 및 리소스의 구성 정보, 상태 정보 및 명세 정보 등이 필요하다. etcd는 이를 key-value 형태로 저장하는 저장소이다. 안정적인 동작을 위해 자료를 분산해서 저장하는 구조를 채택하고 있다. 

* kube-scheduler

쿠버네티스 클러스터는 여러 노드로 구성되어 있으며, 기본적인 작업 단위라고 할 수 있는 파드는 여러 노드 중 특정 노드에 배치되어 동작하게 된다. 이때 새로 생성된 파드를 감지하여 어떤 노드로 배치할지 결정하는 작업을 스케쥴링이라고 한다. 이런 스케쥴링을 담당하는 컴포넌트가 kube-scheduler이다.

* kube-controller-manager

다운된 노드가 없는지, 파드가 의도한 복제 숫자를 유지하고 있는지, 서비스와 파드는 적절하게 연결되어 있는지, 네임스페이스에 대한 기본 계정과 토큰이 생성되어 있는지를 확인하고 적절하지 않다면 적절한 수준을 유지하기 위해 조치하는 역할을 한다.

### 노드 컴포넌트

> 컨트롤 플레인 컴포넌트의 요청을 받아 각 노드에서 동작을 담당한다.

* kublet

쿠블릿은 노드에서 컨테이너가 동작하도록 관리해주는 핵심 요소이다. 각 노드에서 파드를 생성하고 정상적으로 동작하는지 관리하는 역할을 담당하고 있으며, 실제로 우리가 쿠버네티스의 워크로드를 관리하기 위해 내려지는 명령은 쿠블릿을 통해 수행된다고 볼 수 있다. 

우리가 쿠버네티스 파드를 관리하기 위해 작성하는 YAML을 쿠버네티스 클러스터에 적용하기 위해 `kubectl` 명령어를 사용할 때, 이 YAML이 kube-apiserver로 전송된 후 쿠블릿으로 전달된다. 쿠블릿은 이 YAML을 통해 전달된 파드를 생성 혹은 변경하고,  이후 이 YAML에 명시된 컨테이너가 정상적으로 실행되고 있는지 확인한다. 

* container runtime

컨테이너 런타임은 파드에 포함된 컨테이너 실행을 실질적으로 담당하는 어플리케이션을 의밓나다. 단, 컨테이너 런타임은 쿠버네티스 구성 요소에 기본적으로 포함되어 있거나, 특정 소프트웨어를 지칭하는 것은 아니다. 쿠버네티스가 컨테이너를 제어하기 위해 제공하는 표준 규약인 컨테이너 런타임 인터페이스를 준수하여 쿠버네티스와 함께 사용할 수 있는 외부 어플리케이션들을 의미한다.

* kube-proxy

쿠버네티스 클러스터 내부에서 네트워크 요청을 전달하는 역할을 한다. 쿠버네티스 내부에 위치한 특정 파드로 요청을 보내기 위해서 해당 파드의 IP를 정확히 알 필요가 없다. 파드 IP가 배포될 때마다 매번 바뀌는데서 오는 어려움을 해결하기 위해 오브젝트를 통해 고정적으로 파드에 접근할 수 있도록 하는 방법을 제공하기 때문이다.

정리하면, 서비스로 들어온 요청이 파드에 실제로 접근할 수 있는 방법을 관리하는 관리자로, 파드의 IP는 매번 변하지만 kube-proxy가 이 파드에 접근할 수 있는 방법을 그때마다 관리하고 갱신하며, 서비스 오브젝트는 이 정보를 사용하여 파드가 외부에서 접근할 수 있는 경로를 제공한다. 

[쿠버네티스 1,2,3편 정리 - SDS](https://www.samsungsds.com/kr/insights/kubernetes-3.html)